<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Start Page</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f2f4f8;
      --card-bg: #ffffffcc;
      --text: #1a1a1a;
      --muted: #555;
      --accent: #0066cc;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #11161c;
        --card-bg: #1c2230cc;
        --text: #f5f5f5;
        --muted: #bbb;
        --accent: #4ea3ff;
        --shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      }
    }

    :root[data-theme="light"] {
      color-scheme: light;
      --bg: #f2f4f8;
      --card-bg: #ffffffcc;
      --text: #1a1a1a;
      --muted: #555;
      --accent: #0066cc;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
    }

    :root[data-theme="dark"] {
      color-scheme: dark;
      --bg: #11161c;
      --card-bg: #1c2230cc;
      --text: #f5f5f5;
      --muted: #bbb;
      --accent: #4ea3ff;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 48px 16px 32px;
    }

    .page {
      width: min(100%, 960px);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: var(--card-bg);
      color: var(--text);
      font-size: 18px;
      padding: 0;
      line-height: 1;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      z-index: 1000;
    }

    .theme-toggle:hover {
      transform: translateY(-1px);
    }

    .theme-toggle:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .theme-toggle {
        border-color: rgba(255, 255, 255, 0.15);
      }
    }

    :root[data-theme="dark"] .theme-toggle {
      border-color: rgba(255, 255, 255, 0.15);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 24px;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      text-align: right;
    }

    #time {
      font-size: clamp(48px, 8vw, 72px);
      font-weight: 600;
      margin: 0;
    }

    #date {
      margin: 0;
      font-size: clamp(18px, 3vw, 24px);
      color: var(--muted);
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      padding: 24px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card h2 {
      margin: 0;
      font-size: 20px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    input[type="search"] {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      font-size: 16px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="search"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.25);
    }

    button {
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    button.theme-toggle {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 0;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    .prayer-card {
      gap: 12px;
    }

    .prayer-status {
      font-size: 14px;
      color: var(--muted);
    }

    .prayer-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 12px;
    }

    .prayer-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      color: var(--text);
    }

    .prayer-name {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .prayer-time {
      font-size: 18px;
      font-weight: 600;
    }

    .world-clock-card {
      gap: 12px;
    }

    .world-clock-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 12px;
    }

    .world-clock-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      color: var(--text);
    }

    .world-clock-city {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .world-clock-time {
      font-size: 18px;
      font-weight: 600;
    }

    .search-card form {
      width: 100%;
    }

    .search-card form + form {
      margin-top: 16px;
    }

    .search-card input[type="search"] {
      width: 100%;
      padding: 16px 20px;
      font-size: 18px;
      border-radius: 14px;
    }

    .muted {
      color: var(--muted);
      font-size: 15px;
    }

    .verse-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .verse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .verse-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0, 102, 204, 0.12);
      color: var(--accent);
      text-decoration: none;
      font-size: 18px;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .verse-link:hover {
      background: rgba(0, 102, 204, 0.2);
      transform: translateY(-1px);
    }

    .verse-link[aria-disabled="true"] {
      opacity: 0.4;
      pointer-events: none;
    }

    .verse-link:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .verse-arabic {
      font-size: 24px;
      line-height: 1.8;
      direction: rtl;
      text-align: right;
    }

    .verse-text {
      font-size: 18px;
      line-height: 1.6;
    }

    #verse-meta {
      font-size: 15px;
      color: var(--muted);
    }

    #weather {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      text-align: right;
    }

    .weather-temperature {
      font-size: clamp(28px, 6vw, 48px);
      font-weight: 600;
      color: var(--text);
    }

    .weather-forecast {
      font-size: 14px;
      max-width: 260px;
      line-height: 1.4;
      word-break: break-word;
    }

    @media (max-width: 600px) {
      body {
        padding: 32px 12px 24px;
      }

      .card {
        padding: 20px;
      }

      header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }

      .header-left,
      .header-right,
      #weather {
        align-items: center;
        text-align: center;
      }

      .theme-toggle {
        top: 16px;
        right: 16px;
      }
    }
  </style>
</head>
  <body>
  <div class="page">
    <button type="button" id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">☀️</button>
    <header>
      <div class="header-left">
        <div id="time">--:--</div>
        <div id="date">Loading date…</div>
      </div>
      <div class="header-right" id="weather">
        <div id="weather-details" class="weather-temperature">--°F</div>
        <div id="weather-forecast" class="weather-forecast muted">Detecting your location…</div>
      </div>
    </header>

    <section class="card search-card" aria-label="Quick searches">
      <form id="google-search">
        <input type="search" name="query" placeholder="Search the web…" autocomplete="off" />
      </form>
      <form id="gpt-search">
        <input type="search" name="query" placeholder="Start a new chat…" autocomplete="off" />
      </form>
    </section>

    <section class="card prayer-card" aria-label="Prayer times">
      <div class="prayer-row" id="local-prayer-times">
        <div class="prayer-item">
          <span class="prayer-name">Fajr</span>
          <span class="prayer-time" id="local-prayer-fajr">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Shuruq</span>
          <span class="prayer-time" id="local-prayer-shuruq">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Dhuhr</span>
          <span class="prayer-time" id="local-prayer-dhuhr">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Asr</span>
          <span class="prayer-time" id="local-prayer-asr">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Maghrib</span>
          <span class="prayer-time" id="local-prayer-maghrib">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Isha</span>
          <span class="prayer-time" id="local-prayer-isha">--:--</span>
        </div>
      </div>
    </section>

    <section class="card world-clock-card" aria-label="World clocks">
      <div class="world-clock-row" id="world-clock-row">
        <div class="world-clock-item">
          <span class="world-clock-city">Karabuk</span>
          <span class="world-clock-time" data-timezone="Europe/Istanbul">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">London</span>
          <span class="world-clock-time" data-timezone="Europe/London">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">Copenhagen</span>
          <span class="world-clock-time" data-timezone="Europe/Copenhagen">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">Bangalore</span>
          <span class="world-clock-time" data-timezone="Asia/Kolkata">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">Tokyo</span>
          <span class="world-clock-time" data-timezone="Asia/Tokyo">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">Sydney</span>
          <span class="world-clock-time" data-timezone="Australia/Sydney">--:--</span>
        </div>
      </div>
    </section>

    <section class="card verse-card" aria-label="Quran verse">
      <div class="verse-header">
        <div id="verse-meta" class="muted">Loading verse details…</div>
        <a id="open-verse" class="verse-link" href="https://quran.com" target="_blank" rel="noopener" aria-label="Open verse on Quran.com" aria-disabled="true">↗</a>
      </div>
      <div id="verse-arabic" class="verse-arabic">Loading Arabic text...</div>
      <div id="verse-text" class="verse-text">Fetching an ayah…</div>
    </section>
  </div>

  <script>
    const timeEl = document.getElementById('time');
    const dateEl = document.getElementById('date');
    const googleForm = document.getElementById('google-search');
    const gptForm = document.getElementById('gpt-search');
    const verseTextEl = document.getElementById('verse-text');
    const verseMetaEl = document.getElementById('verse-meta');
    const verseArabicEl = document.getElementById('verse-arabic');
    const openVerseLink = document.getElementById('open-verse');
    const weatherDetailsEl = document.getElementById('weather-details');
    const weatherForecastEl = document.getElementById('weather-forecast');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const localPrayerTimeEls = {
      Fajr: document.getElementById('local-prayer-fajr'),
      Sunrise: document.getElementById('local-prayer-shuruq'),
      Dhuhr: document.getElementById('local-prayer-dhuhr'),
      Asr: document.getElementById('local-prayer-asr'),
      Maghrib: document.getElementById('local-prayer-maghrib'),
      Isha: document.getElementById('local-prayer-isha'),
    };
    const worldClockFormatters = Array.from(document.querySelectorAll('.world-clock-time'))
      .map((element) => {
        const timezone = element.dataset.timezone;
        if (!timezone) return null;
        return {
          element,
          formatter: new Intl.DateTimeFormat('en-GB', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true,
            timeZone: timezone,
          }),
        };
      })
      .filter(Boolean);

    const LOCATION_CACHE_KEY = 'startpage:weatherLocation';
    const LOCATION_CACHE_DURATION = 30 * 60 * 1000; // 30 minutes
    const THEME_STORAGE_KEY = 'startpage:theme';
    const prefersDarkMedia = window.matchMedia('(prefers-color-scheme: dark)');

    function normalizeAmPm(value) {
      if (typeof value !== 'string') return value;
      return value.replace(/\b(a|p)\.?m\.?\b/gi, (_, period) => `${period.toUpperCase()}M`);
    }

    function formatClockTime(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '--:--';
      return normalizeAmPm(
        date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true })
      );
    }

    function setLocalPrayerTimesPlaceholder(value = '--:--') {
      Object.values(localPrayerTimeEls).forEach((element) => {
        if (element) element.textContent = value;
      });
    }

    function toRadians(degrees) {
      return (degrees * Math.PI) / 180;
    }

    function normalizeDegrees(value) {
      const result = value % 360;
      return result < 0 ? result + 360 : result;
    }

    function calculateSolarGeometry(julianDay) {
      const n = julianDay - 2451545.0;
      const g = toRadians(357.529 + 0.98560028 * n);
      const q = 280.459 + 0.98564736 * n;
      let L = q + 1.915 * Math.sin(g) + 0.020 * Math.sin(2 * g);
      L = normalizeDegrees(L);
      const e = toRadians(23.439 - 0.00000036 * n);
      const Lrad = toRadians(L);
      const declination = Math.asin(Math.sin(e) * Math.sin(Lrad));
      const equationOfTime =
        229.18 *
        (0.000075 +
          0.001868 * Math.cos(g) -
          0.032077 * Math.sin(g) -
          0.014615 * Math.cos(2 * g) -
          0.040849 * Math.sin(2 * g));
      return { declination, equationOfTime };
    }

    function calculateHourAngle(latitudeRad, declination, solarAngle) {
      const numerator = Math.sin(solarAngle) - Math.sin(latitudeRad) * Math.sin(declination);
      const denominator = Math.cos(latitudeRad) * Math.cos(declination);
      const value = numerator / denominator;
      if (value < -1 || value > 1) return NaN;
      return Math.acos(value);
    }

    function calculateLocalPrayerTimes(latitude, longitude, date = new Date(), options = {}) {
      const settings = {
        fajrAngle: typeof options.fajrAngle === 'number' ? options.fajrAngle : 15,
        ishaAngle: typeof options.ishaAngle === 'number' ? options.ishaAngle : 15,
        asrShadow: options.asrShadow === 1 ? 1 : 2,
      };
      const baseDate = new Date(date);
      const year = baseDate.getFullYear();
      const month = baseDate.getMonth();
      const day = baseDate.getDate();
      const timezoneOffsetHours = -baseDate.getTimezoneOffset() / 60;
      const midnight = Date.UTC(year, month, day);
      const julianDay = midnight / 86400000 + 2440587.5;
      const { declination, equationOfTime } = calculateSolarGeometry(julianDay);
      const latitudeRad = toRadians(latitude);
      const solarNoon = (720 - 4 * longitude - equationOfTime + timezoneOffsetHours * 60) / 60;
      const radToHours = 12 / Math.PI;

      const fajrAngle = toRadians(-settings.fajrAngle);
      const ishaAngle = toRadians(-settings.ishaAngle);
      const sunriseSunsetAngle = toRadians(-0.833);
      const asrAltitude = Math.atan(
        1 / (settings.asrShadow + Math.tan(Math.abs(latitudeRad - declination)))
      );

      const fajrHourAngle = calculateHourAngle(latitudeRad, declination, fajrAngle);
      const sunriseHourAngle = calculateHourAngle(latitudeRad, declination, sunriseSunsetAngle);
      const asrHourAngle = calculateHourAngle(latitudeRad, declination, asrAltitude);
      const sunsetHourAngle = sunriseHourAngle;
      const ishaHourAngle = calculateHourAngle(latitudeRad, declination, ishaAngle);

      const times = {
        Fajr: solarNoon - radToHours * fajrHourAngle,
        Sunrise: solarNoon - radToHours * sunriseHourAngle,
        Dhuhr: solarNoon,
        Asr: solarNoon + radToHours * asrHourAngle,
        Maghrib: solarNoon + radToHours * sunsetHourAngle,
        Isha: solarNoon + radToHours * ishaHourAngle,
      };

      const invalid = Object.values(times).some((value) => Number.isNaN(value));
      if (invalid) return null;

      const results = {};
      Object.entries(times).forEach(([name, hourValue]) => {
        if (typeof hourValue !== 'number' || !Number.isFinite(hourValue)) {
          results[name] = null;
          return;
        }
        const normalizedHours = ((hourValue % 24) + 24) % 24;
        const hours = Math.floor(normalizedHours);
        const minutes = Math.round((normalizedHours - hours) * 60);
        const target = new Date(year, month, day, 0, 0, 0, 0);
        target.setHours(hours, minutes, 0, 0);
        results[name] = target;
      });
      return results;
    }

    function updateLocalPrayerTimes(latitude, longitude, date = new Date()) {
      setLocalPrayerTimesPlaceholder('--:--');
      try {
        const times = calculateLocalPrayerTimes(latitude, longitude, date);
        if (!times) {
          setLocalPrayerTimesPlaceholder();
          return;
        }
        Object.entries(times).forEach(([name, timeValue]) => {
          const element = localPrayerTimeEls[name];
          if (element) {
            element.textContent = formatClockTime(timeValue);
          }
        });
      } catch (error) {
        console.error('Local prayer time calculation failed', error);
        setLocalPrayerTimesPlaceholder();
      }
    }

    function updateClock() {
      const now = new Date();
      const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      timeEl.textContent = normalizeAmPm(now.toLocaleTimeString('en-US', timeOptions));
      dateEl.textContent = now.toLocaleDateString(undefined, dateOptions);
      updateWorldClocks(now);
    }

    function updateWorldClocks(now) {
      if (!worldClockFormatters.length) return;
      worldClockFormatters.forEach(({ element, formatter }) => {
        element.textContent = normalizeAmPm(formatter.format(now));
      });
    }

    function setUpSearchForms() {
      googleForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const query = event.target.query.value.trim();
        if (!query) return;
        const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        window.open(url, '_blank', 'noopener');
      });

      gptForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const query = event.target.query.value.trim();
        if (!query) return;
        const url = `https://chatgpt.com/?q=${encodeURIComponent(query)}`;
        window.open(url, '_blank', 'noopener');
      });
    }

    function getRandomAyahNumber() {
      const totalAyat = 6236;
      return Math.floor(Math.random() * totalAyat) + 1;
    }

    function getCachedLocation() {
      try {
        const stored = localStorage.getItem(LOCATION_CACHE_KEY);
        if (!stored) return null;
        const parsed = JSON.parse(stored);
        const { latitude, longitude, timestamp } = parsed ?? {};
        if (typeof latitude !== 'number' || typeof longitude !== 'number' || typeof timestamp !== 'number') {
          return null;
        }
        if (Date.now() - timestamp > LOCATION_CACHE_DURATION) {
          localStorage.removeItem(LOCATION_CACHE_KEY);
          return null;
        }
        return { latitude, longitude };
      } catch (error) {
        console.error('Unable to read cached location', error);
        return null;
      }
    }

    function setCachedLocation(latitude, longitude) {
      try {
        const payload = JSON.stringify({ latitude, longitude, timestamp: Date.now() });
        localStorage.setItem(LOCATION_CACHE_KEY, payload);
      } catch (error) {
        console.error('Unable to cache location', error);
      }
    }

    function clearCachedLocation() {
      try {
        localStorage.removeItem(LOCATION_CACHE_KEY);
      } catch (error) {
        console.error('Unable to clear cached location', error);
      }
    }

    function readStoredTheme() {
      try {
        const value = localStorage.getItem(THEME_STORAGE_KEY);
        if (value === 'light' || value === 'dark') {
          return value;
        }
      } catch (error) {
        console.error('Unable to read theme preference', error);
      }
      return null;
    }

    function storeThemePreference(theme) {
      try {
        localStorage.setItem(THEME_STORAGE_KEY, theme);
      } catch (error) {
        console.error('Unable to store theme preference', error);
      }
    }

    function updateThemeToggle(resolvedTheme) {
      if (!themeToggleBtn) return;
      const nextTheme = resolvedTheme === 'dark' ? 'light' : 'dark';
      themeToggleBtn.textContent = resolvedTheme === 'dark' ? '🌑' : '⚪';
      themeToggleBtn.setAttribute('aria-label', `Switch to ${nextTheme} mode`);
    }

    function applyThemePreference(theme) {
      if (theme === 'light') {
        document.documentElement.dataset.theme = 'light';
      } else if (theme === 'dark') {
        document.documentElement.dataset.theme = 'dark';
      } else {
        delete document.documentElement.dataset.theme;
      }
      const resolvedTheme = theme || (prefersDarkMedia.matches ? 'dark' : 'light');
      updateThemeToggle(resolvedTheme);
    }

    let manualTheme = readStoredTheme();
    applyThemePreference(manualTheme);

    const handleSystemThemeChange = () => {
      if (!manualTheme) {
        applyThemePreference(null);
      }
    };

    if (prefersDarkMedia.addEventListener) {
      prefersDarkMedia.addEventListener('change', handleSystemThemeChange);
    } else if (prefersDarkMedia.addListener) {
      prefersDarkMedia.addListener(handleSystemThemeChange);
    }

    if (themeToggleBtn) {
      themeToggleBtn.addEventListener('click', () => {
        const currentTheme = manualTheme || (prefersDarkMedia.matches ? 'dark' : 'light');
        const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
        manualTheme = nextTheme;
        storeThemePreference(nextTheme);
        applyThemePreference(nextTheme);
      });
    }

    async function loadRandomVerse() {
      verseMetaEl.textContent = 'Loading verse details…';
      verseTextEl.textContent = 'Fetching an ayah…';
      verseArabicEl.textContent = 'Loading Arabic text...';
      openVerseLink.setAttribute('aria-disabled', 'true');
      openVerseLink.href = 'https://quran.com';
      const ayahNumber = getRandomAyahNumber();
      const url = `https://api.alquran.cloud/v1/ayah/${ayahNumber}/editions/quran-uthmani,tr.yildirim`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Verse request failed');
        const payload = await response.json();
        const data = Array.isArray(payload.data) ? payload.data : [payload.data];
        const arabicEdition = data.find((item) => item.edition?.language === 'ar');
        const translationEdition = data.find((item) => item.edition?.identifier === 'tr.yildirim') || data.find((item) => item.edition?.language === 'tr') || data[0];

        if (!translationEdition) throw new Error('Missing verse translation');

        verseTextEl.textContent = translationEdition.text;
        verseMetaEl.textContent = `${translationEdition.surah.englishName} (${translationEdition.surah.englishNameTranslation}) • Ayet ${translationEdition.numberInSurah}`;

        if (arabicEdition) {
          verseArabicEl.textContent = arabicEdition.text;
        } else {
          verseArabicEl.textContent = '';
        }

        const surahNumber = translationEdition.surah.number;
        const ayahInSurah = translationEdition.numberInSurah;
        openVerseLink.href = `https://quran.com/${surahNumber}/${ayahInSurah}`;
        openVerseLink.setAttribute('aria-label', `Open ${translationEdition.surah.englishName} ayah ${ayahInSurah} on Quran.com`);
        openVerseLink.removeAttribute('aria-disabled');
      } catch (error) {
        verseTextEl.textContent = 'Unable to load a verse right now.';
        verseMetaEl.textContent = '';
        verseArabicEl.textContent = '';
        openVerseLink.setAttribute('aria-disabled', 'true');
        openVerseLink.href = 'https://quran.com';
        openVerseLink.setAttribute('aria-label', 'Open verse on Quran.com');
        console.error(error);
      }
    }

    async function fetchWeather(latitude, longitude) {
      const pointUrl = `https://api.weather.gov/points/${latitude.toFixed(4)},${longitude.toFixed(4)}`;
      try {
        const pointResponse = await fetch(pointUrl, {
          headers: {
            Accept: 'application/geo+json',
          },
        });
        if (!pointResponse.ok) throw new Error('Weather point lookup failed');
        const pointData = await pointResponse.json();
        const forecastUrl = pointData?.properties?.forecast ?? pointData?.properties?.forecastHourly;
        if (!forecastUrl) throw new Error('Missing forecast URL');

        const forecastResponse = await fetch(forecastUrl, {
          headers: {
            Accept: 'application/geo+json',
          },
        });
        if (!forecastResponse.ok) throw new Error('Weather forecast request failed');
        const forecastData = await forecastResponse.json();
        const period = forecastData?.properties?.periods?.[0];
        if (!period) throw new Error('Missing forecast period');

        const {
          shortForecast = 'Current weather',
          detailedForecast = '',
          temperature,
          temperatureUnit,
        } = period;
        const normalizedForecast = detailedForecast.trim() || shortForecast || 'Forecast unavailable.';
        weatherForecastEl.textContent = normalizedForecast;

        const formattedTemp = typeof temperature === 'number'
          ? new Intl.NumberFormat(undefined, {
              maximumFractionDigits: 1,
              minimumFractionDigits: 0,
            }).format(temperature)
          : '--';
        const unitLabel = temperatureUnit === 'F' ? '°F' : `°${temperatureUnit ?? 'F'}`;
        weatherDetailsEl.textContent = `${formattedTemp}${unitLabel}`;
      } catch (error) {
        weatherDetailsEl.textContent = '--°F';
        weatherForecastEl.textContent = 'Unable to load weather.';
        console.error(error);
      }
    }

    function requestWeather() {
      weatherDetailsEl.textContent = '--°F';
      weatherForecastEl.textContent = 'Detecting your location…';
      setLocalPrayerTimesPlaceholder();

      const cached = getCachedLocation();
      if (cached) {
        weatherForecastEl.textContent = 'Loading forecast…';
        fetchWeather(cached.latitude, cached.longitude);
        updateLocalPrayerTimes(cached.latitude, cached.longitude);
        return;
      }

      if (!navigator.geolocation) {
        weatherForecastEl.textContent = 'Geolocation is not supported by your browser.';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          setCachedLocation(latitude, longitude);
          weatherForecastEl.textContent = 'Loading forecast…';
          fetchWeather(latitude, longitude);
          updateLocalPrayerTimes(latitude, longitude);
        },
        (error) => {
          if (error.code === error.PERMISSION_DENIED) {
            weatherForecastEl.textContent = 'Location permission denied. Please allow access to see the weather.';
            clearCachedLocation();
          } else {
            weatherForecastEl.textContent = 'Unable to determine your location.';
          }
          weatherDetailsEl.textContent = '--°F';
          setLocalPrayerTimesPlaceholder();
          console.error(error);
        },
        { enableHighAccuracy: false, timeout: 10000 }
      );
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateClock();
      setInterval(updateClock, 1000);

      setUpSearchForms();
      loadRandomVerse();
      requestWeather();
    });
  </script>
</body>
</html>
