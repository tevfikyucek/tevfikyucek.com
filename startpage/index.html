<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Start Page</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f2f4f8;
      --card-bg: #ffffffcc;
      --text: #1a1a1a;
      --muted: #555;
      --accent: #0066cc;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #11161c;
        --card-bg: #1c2230cc;
        --text: #f5f5f5;
        --muted: #bbb;
        --accent: #4ea3ff;
        --shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      }
    }

    :root[data-theme="light"] {
      color-scheme: light;
      --bg: #f2f4f8;
      --card-bg: #ffffffcc;
      --text: #1a1a1a;
      --muted: #555;
      --accent: #0066cc;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
    }

    :root[data-theme="dark"] {
      color-scheme: dark;
      --bg: #11161c;
      --card-bg: #1c2230cc;
      --text: #f5f5f5;
      --muted: #bbb;
      --accent: #4ea3ff;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 48px 16px 32px;
    }

    .page {
      width: min(100%, 960px);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: var(--card-bg);
      color: var(--text);
      font-size: 18px;
      padding: 0;
      line-height: 1;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      z-index: 1000;
    }

    .theme-toggle:hover {
      transform: translateY(-1px);
    }

    .theme-toggle:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .theme-toggle {
        border-color: rgba(255, 255, 255, 0.15);
      }
    }

    :root[data-theme="dark"] .theme-toggle {
      border-color: rgba(255, 255, 255, 0.15);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 24px;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      text-align: right;
    }

    #time {
      font-size: clamp(48px, 8vw, 72px);
      font-weight: 600;
      margin: 0;
    }

    #date {
      margin: 0;
      font-size: clamp(18px, 3vw, 24px);
      color: var(--muted);
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      padding: 24px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card h2 {
      margin: 0;
      font-size: 20px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    input[type="search"] {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      font-size: 16px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="search"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.25);
    }

    button {
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    button.theme-toggle {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 0;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    .price-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .price-item {
      background: rgba(0, 0, 0, 0.04);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .price-item span {
      font-size: 14px;
      color: var(--muted);
    }

    .price-item strong {
      font-size: 20px;
      font-weight: 600;
    }

    .prayer-card {
      gap: 12px;
    }

    .prayer-status {
      font-size: 14px;
      color: var(--muted);
    }

    .prayer-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 12px;
    }

    .prayer-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.04);
      color: var(--text);
    }

    :root[data-theme="dark"] .prayer-item {
      background: rgba(255, 255, 255, 0.08);
    }

    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .prayer-item {
        background: rgba(255, 255, 255, 0.08);
      }
    }

    .prayer-name {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .prayer-time {
      font-size: 18px;
      font-weight: 600;
    }

    .world-clock-card {
      gap: 12px;
    }

    .world-clock-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 12px;
    }

    .world-clock-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.04);
      color: var(--text);
    }

    :root[data-theme="dark"] .world-clock-item {
      background: rgba(255, 255, 255, 0.08);
    }

    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .world-clock-item {
        background: rgba(255, 255, 255, 0.08);
      }
    }

    .world-clock-city {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .world-clock-time {
      font-size: 18px;
      font-weight: 600;
    }

    .search-card form {
      width: 100%;
    }

    .search-card input[type="search"] {
      width: 100%;
      padding: 16px 20px;
      font-size: 18px;
      border-radius: 14px;
    }

    .muted {
      color: var(--muted);
      font-size: 15px;
    }

    .verse-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .verse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .verse-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0, 102, 204, 0.12);
      color: var(--accent);
      text-decoration: none;
      font-size: 18px;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .verse-link:hover {
      background: rgba(0, 102, 204, 0.2);
      transform: translateY(-1px);
    }

    .verse-link[aria-disabled="true"] {
      opacity: 0.4;
      pointer-events: none;
    }

    .verse-link:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .verse-arabic {
      font-size: 24px;
      line-height: 1.8;
      direction: rtl;
      text-align: right;
    }

    .verse-text {
      font-size: 18px;
      line-height: 1.6;
    }

    #verse-meta {
      font-size: 15px;
      color: var(--muted);
    }

    #weather {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      text-align: right;
    }

    .weather-temperature {
      font-size: clamp(28px, 6vw, 48px);
      font-weight: 600;
      color: var(--text);
    }

    .weather-forecast {
      font-size: 14px;
      max-width: 260px;
      line-height: 1.4;
      word-break: break-word;
    }

    @media (max-width: 600px) {
      body {
        padding: 32px 12px 24px;
      }

      .card {
        padding: 20px;
      }

      header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }

      .header-left,
      .header-right,
      #weather {
        align-items: center;
        text-align: center;
      }

      .theme-toggle {
        top: 16px;
        right: 16px;
      }
    }
  </style>
</head>
  <body>
  <div class="page">
    <button type="button" id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">☀️</button>
    <header>
      <div class="header-left">
        <div id="time">--:--</div>
        <div id="date">Loading date…</div>
      </div>
      <div class="header-right" id="weather">
        <div id="weather-details" class="weather-temperature">--°F</div>
        <div id="weather-forecast" class="weather-forecast muted">Detecting your location…</div>
      </div>
    </header>

    <div class="cards">
      <section class="card search-card" aria-label="Search Google">
        <form id="google-search">
          <input type="search" name="query" placeholder="Search the web…" autocomplete="off" />
        </form>
      </section>

      <section class="card search-card" aria-label="Ask GPT">
        <form id="gpt-search">
          <input type="search" name="query" placeholder="Start a new chat…" autocomplete="off" />
        </form>
      </section>
    </div>

    <section class="card" aria-labelledby="market-data-title">
      <h2 id="market-data-title">Market Snapshot</h2>
      <div id="market-status" class="muted">Loading prices…</div>
      <div class="price-list" id="price-list"></div>
    </section>

    <section class="card prayer-card" aria-label="Prayer times">
      <div id="prayer-status" class="prayer-status">Detecting your location…</div>
      <div class="prayer-row" id="prayer-times">
        <div class="prayer-item">
          <span class="prayer-name">Fajr</span>
          <span class="prayer-time" id="prayer-fajr">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Shuruq</span>
          <span class="prayer-time" id="prayer-shuruq">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Dhuhr</span>
          <span class="prayer-time" id="prayer-dhuhr">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Asr</span>
          <span class="prayer-time" id="prayer-asr">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Maghrib</span>
          <span class="prayer-time" id="prayer-maghrib">--:--</span>
        </div>
        <div class="prayer-item">
          <span class="prayer-name">Isha</span>
          <span class="prayer-time" id="prayer-isha">--:--</span>
        </div>
      </div>
    </section>

    <section class="card world-clock-card" aria-label="World clocks">
      <div class="world-clock-row" id="world-clock-row">
        <div class="world-clock-item">
          <span class="world-clock-city">Karabuk</span>
          <span class="world-clock-time" data-timezone="Europe/Istanbul">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">London</span>
          <span class="world-clock-time" data-timezone="Europe/London">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">Copenhagen</span>
          <span class="world-clock-time" data-timezone="Europe/Copenhagen">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">Bangalore</span>
          <span class="world-clock-time" data-timezone="Asia/Kolkata">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">Tokyo</span>
          <span class="world-clock-time" data-timezone="Asia/Tokyo">--:--</span>
        </div>
        <div class="world-clock-item">
          <span class="world-clock-city">Sydney</span>
          <span class="world-clock-time" data-timezone="Australia/Sydney">--:--</span>
        </div>
      </div>
    </section>

    <section class="card verse-card" aria-label="Quran verse">
      <div class="verse-header">
        <div id="verse-meta" class="muted">Loading verse details…</div>
        <a id="open-verse" class="verse-link" href="https://quran.com" target="_blank" rel="noopener" aria-label="Open verse on Quran.com" aria-disabled="true">↗</a>
      </div>
      <div id="verse-arabic" class="verse-arabic">Loading Arabic text...</div>
      <div id="verse-text" class="verse-text">Fetching an ayah…</div>
    </section>
  </div>

  <script>
    const timeEl = document.getElementById('time');
    const dateEl = document.getElementById('date');
    const googleForm = document.getElementById('google-search');
    const gptForm = document.getElementById('gpt-search');
    const marketStatusEl = document.getElementById('market-status');
    const priceListEl = document.getElementById('price-list');
    const verseTextEl = document.getElementById('verse-text');
    const verseMetaEl = document.getElementById('verse-meta');
    const verseArabicEl = document.getElementById('verse-arabic');
    const openVerseLink = document.getElementById('open-verse');
    const weatherDetailsEl = document.getElementById('weather-details');
    const weatherForecastEl = document.getElementById('weather-forecast');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const prayerStatusEl = document.getElementById('prayer-status');
    const prayerTimeEls = {
      Fajr: document.getElementById('prayer-fajr'),
      Sunrise: document.getElementById('prayer-shuruq'),
      Dhuhr: document.getElementById('prayer-dhuhr'),
      Asr: document.getElementById('prayer-asr'),
      Maghrib: document.getElementById('prayer-maghrib'),
      Isha: document.getElementById('prayer-isha'),
    };
    const worldClockFormatters = Array.from(document.querySelectorAll('.world-clock-time'))
      .map((element) => {
        const timezone = element.dataset.timezone;
        if (!timezone) return null;
        return {
          element,
          formatter: new Intl.DateTimeFormat('en-GB', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true,
            timeZone: timezone,
          }),
        };
      })
      .filter(Boolean);

    const LOCATION_CACHE_KEY = 'startpage:weatherLocation';
    const LOCATION_CACHE_DURATION = 30 * 60 * 1000; // 30 minutes
    const THEME_STORAGE_KEY = 'startpage:theme';
    const prefersDarkMedia = window.matchMedia('(prefers-color-scheme: dark)');

    function normalizeAmPm(value) {
      if (typeof value !== 'string') return value;
      return value.replace(/\b(a|p)\.?m\.?\b/gi, (_, period) => `${period.toUpperCase()}M`);
    }

    function updateClock() {
      const now = new Date();
      const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      timeEl.textContent = normalizeAmPm(now.toLocaleTimeString('en-US', timeOptions));
      dateEl.textContent = now.toLocaleDateString(undefined, dateOptions);
      updateWorldClocks(now);
    }

    function updateWorldClocks(now) {
      if (!worldClockFormatters.length) return;
      worldClockFormatters.forEach(({ element, formatter }) => {
        element.textContent = normalizeAmPm(formatter.format(now));
      });
    }

    function setUpSearchForms() {
      googleForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const query = event.target.query.value.trim();
        if (!query) return;
        const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        window.open(url, '_blank', 'noopener');
      });

      gptForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const query = event.target.query.value.trim();
        if (!query) return;
        const url = `https://chatgpt.com/?q=${encodeURIComponent(query)}`;
        window.open(url, '_blank', 'noopener');
      });
    }

    async function loadMarketData() {
      const symbols = [
        { symbol: 'BTC-USD', label: 'Bitcoin' },
        { symbol: 'QCOM', label: 'Qualcomm' },
        { symbol: 'VTSAX', label: 'VTSAX' },
        { symbol: 'VTIAX', label: 'VTIAX' },
      ];
      const endpoint = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.map((s) => s.symbol).join(',')}`;
      const proxyUrls = [
        `https://corsproxy.io/?${encodeURIComponent(endpoint)}`,
        `https://r.jina.ai/https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.map((s) => s.symbol).join(',')}`,
      ];

      let quotes = null;
      let lastError = null;

      for (const url of proxyUrls) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`Quote request failed (${response.status})`);
          const text = await response.text();
          const payload = JSON.parse(text);
          const results = payload.quoteResponse?.result ?? [];
          if (!results.length) throw new Error('No market data found');
          quotes = results;
          lastError = null;
          break;
        } catch (error) {
          lastError = error;
          console.error('Market data attempt failed', url, error);
        }
      }

      if (!quotes) {
        marketStatusEl.textContent = 'Unable to load market data right now.';
        if (lastError) console.error('Market data unavailable', lastError);
        return;
      }

      priceListEl.innerHTML = '';
      symbols.forEach(({ symbol, label }) => {
        const quote = quotes.find((item) => item.symbol === symbol);
        const price = quote?.regularMarketPrice;
        const currency = quote?.currency || 'USD';
        const card = document.createElement('div');
        card.className = 'price-item';
        card.innerHTML = `
          <span>${label}</span>
          <strong>${price ? price.toLocaleString(undefined, { style: 'currency', currency }) : '—'}</strong>
          <span>${quote?.regularMarketTime ? new Date(quote.regularMarketTime * 1000).toLocaleString() : ''}</span>
        `;
        priceListEl.appendChild(card);
      });
      marketStatusEl.textContent = 'Last refreshed just now.';
    }

    function getRandomAyahNumber() {
      const totalAyat = 6236;
      return Math.floor(Math.random() * totalAyat) + 1;
    }

    function getCachedLocation() {
      try {
        const stored = localStorage.getItem(LOCATION_CACHE_KEY);
        if (!stored) return null;
        const parsed = JSON.parse(stored);
        const { latitude, longitude, timestamp } = parsed ?? {};
        if (typeof latitude !== 'number' || typeof longitude !== 'number' || typeof timestamp !== 'number') {
          return null;
        }
        if (Date.now() - timestamp > LOCATION_CACHE_DURATION) {
          localStorage.removeItem(LOCATION_CACHE_KEY);
          return null;
        }
        return { latitude, longitude };
      } catch (error) {
        console.error('Unable to read cached location', error);
        return null;
      }
    }

    function setCachedLocation(latitude, longitude) {
      try {
        const payload = JSON.stringify({ latitude, longitude, timestamp: Date.now() });
        localStorage.setItem(LOCATION_CACHE_KEY, payload);
      } catch (error) {
        console.error('Unable to cache location', error);
      }
    }

    function clearCachedLocation() {
      try {
        localStorage.removeItem(LOCATION_CACHE_KEY);
      } catch (error) {
        console.error('Unable to clear cached location', error);
      }
    }

    function formatPrayerTime(timeString, dateString) {
      if (!timeString || !dateString) return '--:--';
      const cleanTime = timeString.split(' ')[0];
      if (!cleanTime.includes(':')) return cleanTime;
      const [day, month, year] = dateString.split('-');
      if (!day || !month || !year) return cleanTime;
      const isoDate = `${year}-${month}-${day}`;
      const date = new Date(`${isoDate}T${cleanTime}:00`);
      if (Number.isNaN(date.getTime())) return cleanTime;
      return normalizeAmPm(date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }));
    }

    function setPrayerTimesPlaceholder(value = '--:--') {
      Object.values(prayerTimeEls).forEach((element) => {
        if (element) element.textContent = value;
      });
    }

    function readStoredTheme() {
      try {
        const value = localStorage.getItem(THEME_STORAGE_KEY);
        if (value === 'light' || value === 'dark') {
          return value;
        }
      } catch (error) {
        console.error('Unable to read theme preference', error);
      }
      return null;
    }

    function storeThemePreference(theme) {
      try {
        localStorage.setItem(THEME_STORAGE_KEY, theme);
      } catch (error) {
        console.error('Unable to store theme preference', error);
      }
    }

    function updateThemeToggle(resolvedTheme) {
      if (!themeToggleBtn) return;
      const nextTheme = resolvedTheme === 'dark' ? 'light' : 'dark';
      themeToggleBtn.textContent = resolvedTheme === 'dark' ? '🌑' : '⚪';
      themeToggleBtn.setAttribute('aria-label', `Switch to ${nextTheme} mode`);
    }

    function applyThemePreference(theme) {
      if (theme === 'light') {
        document.documentElement.dataset.theme = 'light';
      } else if (theme === 'dark') {
        document.documentElement.dataset.theme = 'dark';
      } else {
        delete document.documentElement.dataset.theme;
      }
      const resolvedTheme = theme || (prefersDarkMedia.matches ? 'dark' : 'light');
      updateThemeToggle(resolvedTheme);
    }

    let manualTheme = readStoredTheme();
    applyThemePreference(manualTheme);

    const handleSystemThemeChange = () => {
      if (!manualTheme) {
        applyThemePreference(null);
      }
    };

    if (prefersDarkMedia.addEventListener) {
      prefersDarkMedia.addEventListener('change', handleSystemThemeChange);
    } else if (prefersDarkMedia.addListener) {
      prefersDarkMedia.addListener(handleSystemThemeChange);
    }

    if (themeToggleBtn) {
      themeToggleBtn.addEventListener('click', () => {
        const currentTheme = manualTheme || (prefersDarkMedia.matches ? 'dark' : 'light');
        const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
        manualTheme = nextTheme;
        storeThemePreference(nextTheme);
        applyThemePreference(nextTheme);
      });
    }

    async function loadRandomVerse() {
      verseMetaEl.textContent = 'Loading verse details…';
      verseTextEl.textContent = 'Fetching an ayah…';
      verseArabicEl.textContent = 'Loading Arabic text...';
      openVerseLink.setAttribute('aria-disabled', 'true');
      openVerseLink.href = 'https://quran.com';
      const ayahNumber = getRandomAyahNumber();
      const url = `https://api.alquran.cloud/v1/ayah/${ayahNumber}/editions/quran-uthmani,tr.yildirim`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Verse request failed');
        const payload = await response.json();
        const data = Array.isArray(payload.data) ? payload.data : [payload.data];
        const arabicEdition = data.find((item) => item.edition?.language === 'ar');
        const translationEdition = data.find((item) => item.edition?.identifier === 'tr.yildirim') || data.find((item) => item.edition?.language === 'tr') || data[0];

        if (!translationEdition) throw new Error('Missing verse translation');

        verseTextEl.textContent = translationEdition.text;
        verseMetaEl.textContent = `${translationEdition.surah.englishName} (${translationEdition.surah.englishNameTranslation}) • Ayet ${translationEdition.numberInSurah}`;

        if (arabicEdition) {
          verseArabicEl.textContent = arabicEdition.text;
        } else {
          verseArabicEl.textContent = '';
        }

        const surahNumber = translationEdition.surah.number;
        const ayahInSurah = translationEdition.numberInSurah;
        openVerseLink.href = `https://quran.com/${surahNumber}/${ayahInSurah}`;
        openVerseLink.setAttribute('aria-label', `Open ${translationEdition.surah.englishName} ayah ${ayahInSurah} on Quran.com`);
        openVerseLink.removeAttribute('aria-disabled');
      } catch (error) {
        verseTextEl.textContent = 'Unable to load a verse right now.';
        verseMetaEl.textContent = '';
        verseArabicEl.textContent = '';
        openVerseLink.setAttribute('aria-disabled', 'true');
        openVerseLink.href = 'https://quran.com';
        openVerseLink.setAttribute('aria-label', 'Open verse on Quran.com');
        console.error(error);
      }
    }

    async function fetchWeather(latitude, longitude) {
      const pointUrl = `https://api.weather.gov/points/${latitude.toFixed(4)},${longitude.toFixed(4)}`;
      try {
        const pointResponse = await fetch(pointUrl, {
          headers: {
            Accept: 'application/geo+json',
          },
        });
        if (!pointResponse.ok) throw new Error('Weather point lookup failed');
        const pointData = await pointResponse.json();
        const forecastUrl = pointData?.properties?.forecast ?? pointData?.properties?.forecastHourly;
        if (!forecastUrl) throw new Error('Missing forecast URL');

        const forecastResponse = await fetch(forecastUrl, {
          headers: {
            Accept: 'application/geo+json',
          },
        });
        if (!forecastResponse.ok) throw new Error('Weather forecast request failed');
        const forecastData = await forecastResponse.json();
        const period = forecastData?.properties?.periods?.[0];
        if (!period) throw new Error('Missing forecast period');

        const {
          shortForecast = 'Current weather',
          detailedForecast = '',
          temperature,
          temperatureUnit,
        } = period;
        const normalizedForecast = detailedForecast.trim() || shortForecast || 'Forecast unavailable.';
        weatherForecastEl.textContent = normalizedForecast;

        const formattedTemp = typeof temperature === 'number'
          ? new Intl.NumberFormat(undefined, {
              maximumFractionDigits: 1,
              minimumFractionDigits: 0,
            }).format(temperature)
          : '--';
        const unitLabel = temperatureUnit === 'F' ? '°F' : `°${temperatureUnit ?? 'F'}`;
        weatherDetailsEl.textContent = `${formattedTemp}${unitLabel}`;
      } catch (error) {
        weatherDetailsEl.textContent = '--°F';
        weatherForecastEl.textContent = 'Unable to load weather.';
        console.error(error);
      }
    }

    async function fetchPrayerTimes(latitude, longitude) {
      if (!prayerStatusEl) return;
      prayerStatusEl.textContent = 'Fetching prayer times…';
      const url = `https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=2&school=1`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Prayer times request failed');
        const payload = await response.json();
        const timings = payload?.data?.timings;
        const dateString = payload?.data?.date?.gregorian?.date;
        if (!timings || !dateString) throw new Error('Missing prayer timings');
        const targetTimings = {
          Fajr: timings.Fajr,
          Sunrise: timings.Sunrise,
          Dhuhr: timings.Dhuhr,
          Asr: timings.Asr,
          Maghrib: timings.Maghrib,
          Isha: timings.Isha,
        };
        Object.entries(targetTimings).forEach(([name, timeValue]) => {
          const element = prayerTimeEls[name];
          if (element) {
            element.textContent = formatPrayerTime(timeValue, dateString);
          }
        });
        prayerStatusEl.textContent = 'Prayer times • ISNA (Hanafi)';
      } catch (error) {
        prayerStatusEl.textContent = 'Unable to load prayer times.';
        setPrayerTimesPlaceholder();
        console.error(error);
      }
    }

    function requestWeather() {
      weatherDetailsEl.textContent = '--°F';
      weatherForecastEl.textContent = 'Detecting your location…';
      if (prayerStatusEl) {
        prayerStatusEl.textContent = 'Detecting your location…';
        setPrayerTimesPlaceholder();
      }

      const cached = getCachedLocation();
      if (cached) {
        weatherForecastEl.textContent = 'Loading forecast…';
        fetchWeather(cached.latitude, cached.longitude);
        fetchPrayerTimes(cached.latitude, cached.longitude);
        return;
      }

      if (!navigator.geolocation) {
        weatherForecastEl.textContent = 'Geolocation is not supported by your browser.';
        if (prayerStatusEl) {
          prayerStatusEl.textContent = 'Geolocation is not supported by your browser.';
          setPrayerTimesPlaceholder();
        }
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          setCachedLocation(latitude, longitude);
          weatherForecastEl.textContent = 'Loading forecast…';
          fetchWeather(latitude, longitude);
          fetchPrayerTimes(latitude, longitude);
        },
        (error) => {
          if (error.code === error.PERMISSION_DENIED) {
            weatherForecastEl.textContent = 'Location permission denied. Please allow access to see the weather.';
            clearCachedLocation();
          } else {
            weatherForecastEl.textContent = 'Unable to determine your location.';
          }
          weatherDetailsEl.textContent = '--°F';
          if (prayerStatusEl) {
            prayerStatusEl.textContent = 'Unable to determine your location.';
            setPrayerTimesPlaceholder();
          }
          console.error(error);
        },
        { enableHighAccuracy: false, timeout: 10000 }
      );
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateClock();
      setInterval(updateClock, 1000);

      setUpSearchForms();
      loadMarketData();
      loadRandomVerse();
      requestWeather();
    });
  </script>
</body>
</html>
